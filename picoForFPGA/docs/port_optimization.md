# 端口优化说明

## 概述

为了简化FPGA集成和减少外部引脚数量，我们提供了端口优化的顶层模块 `picosoc_top.v`，它与原有的 `picosoc.v` 并存，提供不同的使用场景。

## 顶层模块关系

### picosoc.v (基础版本)
- **功能**: 完整的SoC接口，包含所有外设端口
- **用途**: 开发和调试，需要完整控制的项目
- **特点**: 提供最大的灵活性和控制能力

### picosoc_top.v (端口优化版本)
- **功能**: 在 `picosoc.v` 基础上进行端口优化
- **用途**: 生产部署，资源受限的FPGA
- **特点**: 减少外部引脚，简化集成

## 优化特性

### 1. 端口数量减少
- **原始模块**: 包含所有外设端口、中断、PCPI等
- **优化模块**: 仅暴露9个必要的外部引脚

### 2. QSPI Flash时钟复用
- 使用STARTUPE2原语将Flash时钟复用到FPGA专用CCLK
- 减少布线复杂度，提高时钟质量
- 符合Artix-7系列FPGA的最佳实践

### 3. 内部信号处理
- 片上总线信号在模块内部处理
- 外部中断信号固定为低电平
- PCPI接口在模块内部忽略

## 引脚定义

| 引脚名 | 方向 | 描述 | 约束文件中的引脚 |
|--------|------|------|------------------|
| clk_50m | 输入 | 50MHz系统时钟 | W19 |
| rst_btn_n | 输入 | 复位按键（低有效） | Y19 |
| ser_rx | 输入 | UART接收 | W17 |
| ser_tx | 输出 | UART发送 | V17 |
| flash_csb | 输出 | Flash片选 | T19 |
| flash_io0 | 双向 | Flash数据线0 | P22 |
| flash_io1 | 双向 | Flash数据线1 | R22 |
| flash_io2 | 双向 | Flash数据线2 | P21 |
| flash_io3 | 双向 | Flash数据线3 | R21 |

## 使用方法

### Vivado项目设置
1. 添加所有RTL文件（按vivado_file_list.txt顺序）
2. **重要**: 两个顶层模块都需要添加到项目中
3. 根据需求选择顶层模块：
   - 完整接口：设置 `picosoc` 为顶层
   - 端口优化：设置 `picosoc_top` 为顶层
4. 添加相应的约束文件
5. 综合并生成比特流

### 约束文件选择
- **完整接口**: 使用 `constraints/vivado_template.xdc`
- **端口优化**: 使用 `constraints/artix7_mini.xdc`

## 兼容性

### 支持的硬件
- 升腾/野火Mini Artix-7 XC7A100T-FGG484 (推荐使用优化版本)
- 其他Artix-7系列FPGA（需要调整约束）
- 需要完整接口的任意FPGA (使用基础版本)

### 使用场景对比

| 场景 | 推荐模块 | 原因 |
|------|----------|------|
| 开发调试 | picosoc.v | 完整接口，便于调试 |
| 升腾/野火Mini | picosoc_top.v | 端口优化，资源匹配 |
| 需要外部中断 | picosoc.v | 支持完整中断接口 |
| 需要PCPI | picosoc.v | 支持协处理器接口 |
| 生产部署 | picosoc_top.v | 简化集成，减少引脚 |

## 注意事项

1. **模块共存**: 两个顶层模块都需要添加到Vivado项目中
2. **顶层选择**: 根据项目需求选择其中一个作为顶层模块
3. **时钟复用**: Flash时钟通过STARTUPE2输出，确保约束文件正确配置
4. **IO缓冲**: 使用IOBUF原语处理双向信号
5. **复位处理**: 复位信号直接连接到SoC，内部进行同步
6. **未使用信号**: 外部中断固定为低电平，PCPI接口忽略

## 扩展建议

如果需要添加更多外部接口：
1. 复制 `picosoc_top.v` 为新的顶层模块
2. 添加所需的外部端口
3. 在模块内部连接到SoC的相应接口
4. 更新约束文件添加新的引脚分配

## 迁移指南

### 从基础版本迁移到优化版本
1. 确保项目不需要外部中断或PCPI接口
2. 将顶层模块从 `picosoc` 改为 `picosoc_top`
3. 更新约束文件为 `artix7_mini.xdc`
4. 验证功能正常

### 从优化版本迁移到基础版本
1. 将顶层模块从 `picosoc_top` 改为 `picosoc`
2. 更新约束文件，添加所需的外部引脚
3. 连接外部中断和PCPI接口（如需要） 