# PicoSoC架构文档

## 概述

PicoSoC是一个基于PicoRV32 RISC-V CPU的完整SoC系统，专为FPGA开发设计。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        PicoSoC                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   PicoRV32  │  │   UART      │  │   SPI Flash │         │
│  │    CPU      │  │ Controller  │  │ Controller  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│         │                │                │                │
│         └────────────────┼────────────────┘                │
│                          │                                 │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Memory Controller                          │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │   Internal  │  │   SPI Flash │  │   External  │     │ │
│  │  │     RAM     │  │    Memory   │  │   Memory    │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. PicoRV32 CPU

- **指令集**: RV32I (可选RV32M, RV32C)
- **流水线**: 单周期执行，多周期内存访问
- **寄存器**: 32个通用寄存器
- **中断**: 支持32个中断源
- **性能**: 250-450 MHz (Xilinx 7系列)

### 2. 内存系统

#### 内部SRAM
- **容量**: 4KB (可配置)
- **地址**: 0x00000000 - 0x00000FFF
- **用途**: 栈、堆、临时数据

#### SPI Flash
- **容量**: 1MB (可配置)
- **地址**: 0x00100000 - 0x001FFFFF
- **用途**: 程序存储、只读数据

#### 外部内存
- **地址**: 0x03000000 - 0xFFFFFFFF
- **用途**: 用户外设、扩展内存

### 3. 外设系统

#### UART控制器
- **地址**: 0x02000004 - 0x0200000B
- **功能**: 串口通信
- **波特率**: 可配置
- **数据格式**: 8N1

#### SPI Flash控制器
- **地址**: 0x02000000 - 0x02000003
- **功能**: SPI Flash配置
- **模式**: 支持SPI/QSPI/DDR

#### GPIO控制器
- **地址**: 0x03000000 - 0x030000FF
- **功能**: 通用输入输出
- **数量**: 可配置

## 总线架构

### 内存总线
- **类型**: 简单内存总线
- **宽度**: 32位
- **协议**: 简单的读写协议
- **特性**: 支持字节、半字、字访问

### 外设总线
- **类型**: 内存映射I/O
- **地址**: 32位
- **数据**: 32位
- **控制**: 读写使能、字节使能

## 中断系统

### 中断源
- **IRQ 0-3**: 保留
- **IRQ 4**: 定时器中断
- **IRQ 5-7**: 外部中断
- **IRQ 8-31**: 用户中断

### 中断处理
- **向量表**: 位于0x00000010
- **优先级**: 固定优先级
- **屏蔽**: 可配置中断屏蔽

## 时钟系统

### 系统时钟
- **频率**: 可配置 (典型12MHz-100MHz)
- **来源**: 外部时钟输入
- **分频**: 内部可配置分频器

### 外设时钟
- **UART**: 可配置分频
- **定时器**: 系统时钟分频
- **SPI**: 可配置分频

## 复位系统

### 复位源
- **上电复位**: 自动复位
- **外部复位**: 外部复位信号
- **看门狗复位**: 可配置

### 复位行为
- **CPU**: 复位到0x00100000
- **外设**: 复位到默认状态
- **内存**: 保持内容

## 配置选项

### CPU配置
```verilog
parameter ENABLE_MUL = 1;        // 乘法指令
parameter ENABLE_DIV = 1;        // 除法指令
parameter ENABLE_IRQ = 1;        // 中断支持
parameter COMPRESSED_ISA = 1;    // 压缩指令
```

### 内存配置
```verilog
parameter MEM_WORDS = 1024;      // SRAM大小
parameter FLASH_SIZE = 1048576;  // Flash大小
```

### 外设配置
```verilog
parameter UART_BAUDRATE = 115200; // UART波特率
parameter GPIO_COUNT = 8;         // GPIO数量
```

## 性能特性

### 指令性能
- **CPI**: 1.0 (大部分指令)
- **分支**: 1-2周期
- **内存**: 1-3周期
- **乘除法**: 多周期

### 资源使用
- **LUT**: 750-2000 (Xilinx 7系列)
- **寄存器**: 500-1000
- **BRAM**: 1-2块
- **DSP**: 0-2个 (可选)

### 功耗特性
- **静态功耗**: 低
- **动态功耗**: 与频率成正比
- **睡眠模式**: 支持

## 扩展接口

### PCPI接口
- **用途**: 协处理器接口
- **协议**: 简单协议
- **应用**: 乘法器、除法器、自定义指令

### 调试接口
- **类型**: 简单调试接口
- **功能**: 寄存器访问、内存访问
- **协议**: 自定义协议

## 开发指南

### 添加新外设
1. 创建外设模块
2. 定义内存映射地址
3. 集成到SoC顶层
4. 更新文档

### 修改内存映射
1. 修改内存控制器
2. 更新地址解码
3. 调整链接脚本
4. 测试验证

### 性能优化
1. 分析瓶颈
2. 优化关键路径
3. 调整流水线
4. 验证功能 